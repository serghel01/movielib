<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MovieLib - Demo</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{--accent:#e50914}
    body{background:#0f0f0f;color:#eee;font-family:Inter,Arial,Helvetica,sans-serif}
    .navbar{background:#000}
    .brand{color:var(--accent);font-weight:700}
    .movie-card{background:#151515;border-radius:8px;overflow:hidden;transition:transform .18s}
    .movie-card:hover{transform:scale(1.03)}
    .sidebar{width:240px;background:#0b0b0b;position:fixed;top:0;left:0;height:100vh;padding-top:64px;display:none}
    .sidebar a{color:#cfcfcf;padding:12px 18px;display:block;text-decoration:none}
    .sidebar a:hover{background:var(--accent);color:#fff}
    #adminContent{margin-left:0;transition:margin-left .2s;padding:18px}
    #adminContent.open{margin-left:240px}
    .carousel-item img{height:420px;object-fit:cover}
    .card img{object-fit:cover}
    footer{opacity:.7;padding:24px 0}
    .small-muted{color:#bdbdbd}
    .centered {min-height: 60vh; display:flex; align-items:center; justify-content:center}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand brand" href="#">üé¨ MovieLib</a>
      <div class="d-flex gap-2 align-items-center">
        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#loginModal" id="openLoginBtn">Login</button>
        <button class="btn btn-danger d-none" id="logoutBtn">Logout</button>
        <button class="btn btn-dark border border-2 text-light d-none" id="openDashboardBtn">Dashboard</button>
      </div>
    </div>
  </nav>

  <!-- SIDEBAR (admin) -->
  <div class="sidebar" id="sidebar">
    <a href="#" onclick="showAdminSection('admin_add')">üì• Agregar pel√≠cula</a>
    <a href="#" onclick="showAdminSection('admin_list')">üìã Listado</a>
    <a href="#" onclick="showAdminSection('admin_player')">‚ñ∂Ô∏è Reproductor</a>
  </div>

  <!-- HERO CARRUSEL -->
  <div class="container mt-5 pt-4">
    <div id="heroCarousel" class="carousel slide mb-4">
      <div class="carousel-inner" id="carouselInner"></div>
      <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>

    <!-- GRID PEL√çCULAS -->
    <div id="publicGridContainer">
      <div class="row" id="publicGrid"></div>
    </div>

    <div id="emptyNotice" class="centered d-none">
      <div class="text-center">
        <h3>No hay pel√≠culas a√∫n</h3>
        <p class="small-muted">Inicia sesi√≥n como admin y sube la primera pel√≠cula.</p>
      </div>
    </div>
  </div>

  <!-- ADMIN CONTENT (oculto inicialmente) -->
  <div id="adminContent" class="container-fluid">
    <div id="admin_add" class="admin-section d-none">
      <h3 class="mb-3">Agregar pel√≠cula</h3>
      <form id="formAdd">
        <div class="mb-2"><input id="fldTitle" class="form-control" placeholder="T√≠tulo" required></div>
        <div class="mb-2"><textarea id="fldDesc" class="form-control" placeholder="Descripci√≥n"></textarea></div>
        <div class="mb-2"><label class="form-label small-muted">Poster (imagen)</label><input id="fldPoster" type="file" accept="image/*" class="form-control" required></div>
        <div class="mb-2"><label class="form-label small-muted">Video (mp4 recomendado)</label><input id="fldVideo" type="file" accept="video/*" class="form-control" required></div>
        <div class="mb-2"><div class="progress"><div id="uploadProgress" class="progress-bar bg-danger" role="progressbar" style="width:0%">0%</div></div></div>
        <div class="mb-2"><button id="btnUpload" class="btn btn-danger">Subir pel√≠cula</button></div>
      </form>
    </div>

    <div id="admin_list" class="admin-section d-none">
      <h3 class="mb-3">Listado de pel√≠culas</h3>
      <div id="adminList"></div>
    </div>

    <div id="admin_player" class="admin-section d-none">
      <h3 class="mb-3">Reproductor admin (preview)</h3>
      <video id="adminPreview" controls class="w-100" style="background:#000"></video>
    </div>
  </div>

  <!-- MODAL Reproductor p√∫blico -->
  <div class="modal fade" id="modalPlayer" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark">
        <div class="modal-header border-0">
          <h5 id="modalTitle" class="modal-title"></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <video id="publicPlayer" class="w-100" controls style="background:#000"></video>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL LOGIN -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-0"><h5 class="modal-title">Iniciar sesi√≥n</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input id="loginEmail" type="email" class="form-control mb-2" placeholder="Correo">
          <input id="loginPass" type="password" class="form-control mb-2" placeholder="Contrase√±a">
        </div>
        <div class="modal-footer"><button id="btnLogin" class="btn btn-danger w-100">Ingresar</button></div>
      </div>
    </div>
  </div>

  <footer class="text-center text-muted mt-4">MovieLib ‚Äî demo</footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
  // -------------------- FIREBASE (modular) --------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, doc, deleteDoc, updateDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

  // Tu configuraci√≥n (ya pegada)
  const firebaseConfig = {
    apiKey: "AIzaSyAximGEWo7btApeke9jSLFJ5mxljKCkvRk",
    authDomain: "movielib-7ccdc.firebaseapp.com",
    projectId: "movielib-7ccdc",
    storageBucket: "movielib-7ccdc.firebasestorage.app",
    messagingSenderId: "177203821691",
    appId: "1:177203821691:web:e9b699f7b11e1ffe6876de",
    measurementId: "G-YZCMVNW6S4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Tu UID admin
  const adminUID = "zmfr5MKrcPWacHaEB7p3obJ7Dcm2";

  // -------------------- UI refs --------------------
  const openLoginBtn = document.getElementById('openLoginBtn');
  const btnLogin = document.getElementById('btnLogin');
  const logoutBtn = document.getElementById('logoutBtn');
  const openDashboardBtn = document.getElementById('openDashboardBtn');
  const sidebar = document.getElementById('sidebar');
  const adminContent = document.getElementById('adminContent');
  const btnUpload = document.getElementById('btnUpload');
  const progressBar = document.getElementById('uploadProgress');

  const publicGrid = document.getElementById('publicGrid');
  const carouselInner = document.getElementById('carouselInner');
  const emptyNotice = document.getElementById('emptyNotice');

  // Admin elements
  const formAdd = document.getElementById('formAdd');

  // -------------------- Demo fallback data --------------------
  // Si Firestore viene vac√≠o, mostramos estas pel√≠culas demo (para que siempre veas algo)
  const fallbackMovies = [
    {
      title: "Pel√≠cula demo: El Viaje",
      description: "Demo - tr√°iler p√∫blico",
      posterURL: "https://images.unsplash.com/photo-1517604931442-277d0b6e3b3a?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=ed9d7ff0f3f3a7d1b4a1b9c6d7a8e9c0",
      movieURL: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
    },
    {
      title: "Pel√≠cula demo: Nocturno",
      description: "Demo - peque√±o corto",
      posterURL: "https://images.unsplash.com/photo-1524985069026-dd778a71c7b4?q=80&w=1200&auto=format&fit=crop&ixlib=rb-4.0.3&s=7c1b3c3a8e4d3f1f2e3d4c5b6a7f8e9d",
      movieURL: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"
    }
  ];

  // -------------------- Auth handlers --------------------
  btnLogin.addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    if (!email || !pass) return alert('Completa email y contrase√±a');
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      const modalEl = document.getElementById('loginModal');
      bootstrap.Modal.getInstance(modalEl)?.hide();
      console.log('Usuario logueado:', email);
    } catch (err) {
      console.error('Login error:', err);
      alert('Error login: ' + err.message);
    }
  });

  logoutBtn.addEventListener('click', async () => {
    try { await signOut(auth); console.log('Logout ok'); } catch(e){console.error(e)}
  });

  onAuthStateChanged(auth, user => {
    if (user) {
      logoutBtn.classList.remove('d-none');
      openLoginBtn.classList.add('d-none');
      if (user.uid === adminUID) {
        openDashboardBtn.classList.remove('d-none');
      } else {
        openDashboardBtn.classList.add('d-none');
      }
    } else {
      logoutBtn.classList.add('d-none');
      openLoginBtn.classList.remove('d-none');
      openDashboardBtn.classList.add('d-none');
      // hide admin UI when logged out
      sidebar.style.display = 'none';
      adminContent.classList.remove('open');
    }
  });

  // -------------------- Admin UI --------------------
  function showAdminSection(id) {
    document.querySelectorAll('.admin-section').forEach(s => s.classList.add('d-none'));
    document.getElementById(id).classList.remove('d-none');
  }
  window.showAdminSection = showAdminSection;

  openDashboardBtn.addEventListener('click', () => {
    sidebar.style.display = 'block';
    adminContent.classList.add('open');
    showAdminSection('admin_add');
    window.scrollTo(0,0);
  });

  // -------------------- Firestore realtime listener --------------------
  const moviesRef = collection(db, 'movies');
  const q = query(moviesRef, orderBy('createdAt','desc'));

  let hasRemote = false;
  onSnapshot(q, snapshot => {
    if (!snapshot) return;
    // si no hay docs, cargamos fallback
    if (snapshot.empty) {
      console.log('Firestore vac√≠o ‚Üí mostrando demo local');
      renderFromArray(fallbackMovies);
      hasRemote = false;
      return;
    }
    hasRemote = true;
    renderFromSnapshot(snapshot);
  }, err => {
    console.error('onSnapshot error:', err);
    // En caso de error (p. ej. reglas), mostramos demos para que UI no quede vac√≠a
    renderFromArray(fallbackMovies);
  });

  // -------------------- Renderers --------------------
  function renderFromSnapshot(snapshot) {
    publicGrid.innerHTML = ''; carouselInner.innerHTML = '';
    let first = true;
    snapshot.forEach(docSnap => {
      const m = docSnap.data();
      m._id = docSnap.id;
      renderMovieCard(m, false);
      renderCarouselItem(m, first);
      first = false;
    });
    emptyNotice.classList.toggle('d-none', snapshot.size > 0);
  }

  function renderFromArray(arr) {
    publicGrid.innerHTML = ''; carouselInner.innerHTML = '';
    let first = true;
    arr.forEach(m => {
      renderMovieCard(m, false);
      renderCarouselItem(m, first);
      first = false;
    });
    emptyNotice.classList.toggle('d-none', arr.length > 0);
  }

  function renderMovieCard(m, admin=false) {
    const col = document.createElement('div');
    col.className = 'col-6 col-md-3 mb-4';
    col.innerHTML = `
      <div class="movie-card p-2 h-100">
        <img src="${m.posterURL || m.poster}" class="w-100 mb-2" style="height:260px;object-fit:cover">
        <h6 class="mb-1">${escapeHtml(m.title)}</h6>
        <p class="small text-muted mb-2">${escapeHtml((m.description||m.desc||'').slice(0,80))}</p>
        <div class="d-grid gap-2">
          <button class="btn btn-danger btn-play">Reproducir</button>
        </div>
      </div>`;
    // bind
    col.querySelector('.btn-play').addEventListener('click', () => {
      const url = m.movieURL || m.movie;
      playPublic(url, m.title);
    });
    publicGrid.appendChild(col);
  }

  function renderCarouselItem(m, isFirst) {
    const div = document.createElement('div');
    div.className = 'carousel-item' + (isFirst ? ' active' : '');
    div.innerHTML = `<img src="${m.posterURL || m.poster}" class="d-block w-100"><div class="carousel-caption d-none d-md-block"><h5>${escapeHtml(m.title)}</h5></div>`;
    carouselInner.appendChild(div);
  }

  // -------------------- Play public --------------------
  function playPublic(url, title) {
    if(!url) return alert('No hay URL de video.');
    const player = document.getElementById('publicPlayer');
    document.getElementById('modalTitle').innerText = title || '';
    player.src = url;
    new bootstrap.Modal(document.getElementById('modalPlayer')).show();
  }
  // stop on hide
  document.getElementById('modalPlayer').addEventListener('hidden.bs.modal', () => {
    const p = document.getElementById('publicPlayer');
    p.pause(); p.removeAttribute('src'); p.load();
  });

  // -------------------- Upload (admin) --------------------
  formAdd.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const user = auth.currentUser;
    if (!user) return alert('Debes iniciar sesi√≥n como admin para subir.');
    if (user.uid !== adminUID) return alert('No eres admin.');

    const title = document.getElementById('fldTitle').value.trim();
    const description = document.getElementById('fldDesc').value.trim();
    const posterF = document.getElementById('fldPoster').files[0];
    const videoF  = document.getElementById('fldVideo').files[0];
    if (!title || !posterF || !videoF) return alert('Faltan campos.');

    try {
      btnUpload.disabled = true;
      progressBar.style.width = '0%'; progressBar.innerText = '0%';
      console.log('Subida: comenzando upload de poster...');

      // poster
      const posterRef = ref(storage, `posters/${Date.now()}_${posterF.name}`);
      const upPoster = uploadBytesResumable(posterRef, posterF);
      await new Promise((resolve, reject) => {
        upPoster.on('state_changed', ()=>{}, reject, resolve);
      });
      const posterURL = await getDownloadURL(posterRef);
      console.log('Poster subido:', posterURL);

      // video
      const videoRef = ref(storage, `movies/${Date.now()}_${videoF.name}`);
      const upVideo = uploadBytesResumable(videoRef, videoF);
      await new Promise((resolve, reject) => {
        upVideo.on('state_changed', (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          progressBar.style.width = pct + '%';
          progressBar.innerText = pct + '%';
        }, reject, resolve);
      });
      const movieURL = await getDownloadURL(videoRef);
      console.log('Video subido:', movieURL);

      // guardar doc
      const docRef = await addDoc(collection(db, 'movies'), { title, description, posterURL, movieURL, createdAt: serverTimestamp() });
      console.log('Documento creado:', docRef.id);
      alert('Pel√≠cula subida correctamente ‚úÖ');
      formAdd.reset();
      progressBar.style.width = '0%'; progressBar.innerText = '0%';
    } catch (err) {
      console.error('Error subiendo:', err);
      alert('Error al subir: ' + err.message);
    } finally {
      btnUpload.disabled = false;
    }
  });

  // -------------------- Admin list (render + actions) --------------------
  function renderAdminList(snapshot) {
    const list = document.getElementById('adminList');
    list.innerHTML = '';
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const id = docSnap.id;
      const row = document.createElement('div');
      row.className = 'd-flex align-items-center justify-content-between p-2 border-bottom';
      row.innerHTML = `
        <div>
          <strong>${escapeHtml(data.title || data.title)}</strong><br>
          <small class="text-muted">${escapeHtml(data.description || data.desc || '')}</small>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-light play-preview">‚ñ∂Ô∏è</button>
          <button class="btn btn-sm btn-outline-primary edit-btn">Editar</button>
          <button class="btn btn-sm btn-outline-danger delete-btn">Eliminar</button>
        </div>
      `;
      // play preview
      row.querySelector('.play-preview').addEventListener('click', () => {
        document.getElementById('adminPreview').src = data.movieURL || data.movie;
        showAdminSection('admin_player');
      });
      // edit
      row.querySelector('.edit-btn').addEventListener('click', async () => {
        const newTitle = prompt('Nuevo t√≠tulo', data.title || '');
        const newDesc = prompt('Nueva descripci√≥n', data.description || data.desc || '');
        if (newTitle == null) return;
        try {
          await updateDoc(doc(db, 'movies', id), { title: newTitle, description: newDesc });
          alert('Actualizado');
        } catch (e) { console.error(e); alert('Error al actualizar: ' + e.message); }
      });
      // delete
      row.querySelector('.delete-btn').addEventListener('click', async () => {
        if (!confirm('Eliminar esta pel√≠cula?')) return;
        try {
          await deleteDoc(doc(db, 'movies', id));
          alert('Eliminada');
        } catch (e) { console.error(e); alert('Error al eliminar: ' + e.message); }
      });

      list.appendChild(row);
    });
  }

  // Attach admin list listener too (so admin list updates)
  // reuse same query 'q'
  onSnapshot(q, snapshot => {
    if(!snapshot.empty) {
      renderAdminList(snapshot);
    } else {
      // if no remote docs, admin list empty
      document.getElementById('adminList').innerHTML = '<p class="small-muted">A√∫n no hay pel√≠culas en Firestore.</p>';
    }
  }, err => console.error('admin list snapshot err', err));

  // -------------------- Helpers --------------------
  function escapeHtml(s='') {
    return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  </script>
</body>
</html>
